---
interface Props {
  entry: {
    id: string;
    title: string;
    description: string;
    links: Array<{ title: string; url: string }>;
    tags: string[];
    category: string;
  };
}

const { entry } = Astro.props;

// Find repository link for title, or use first link
const titleLink = entry.links.find(link => link.title.toLowerCase() === 'repository') || entry.links[0];

// GitHub edit URL
const editUrl = `https://github.com/lattice-software/list/edit/master/src/data/entries/${entry.id}.yaml`;

// Extract domain from URL (remove protocol, www, and path)
function getDomain(url: string): string {
  try {
    const urlObj = new URL(url);
    let hostname = urlObj.hostname;
    // Remove www. prefix
    if (hostname.startsWith('www.')) {
      hostname = hostname.slice(4);
    }
    return hostname;
  } catch {
    // Fallback for invalid URLs
    return url.replace(/^https?:\/\//, '').replace(/^www\./, '').split('/')[0];
  }
}
---

<div class="entry-card" data-entry-id={entry.id} data-tags={entry.tags.join(',')} data-category={entry.category}>
  <a href={editUrl} target="_blank" rel="noopener noreferrer" class="edit-icon" title="Edit on GitHub">
    edit
  </a>
  <h3 class="card-title">
    <a href={titleLink.url} target="_blank" rel="noopener noreferrer">
      {entry.title}
    </a>
  </h3>

  <div class="card-description-wrapper">
    <p class="card-description" data-full-text={entry.description}>{entry.description}</p>
    <button class="read-more-btn" style="display: none;">Read more</button>
  </div>

  <div class="card-tags">
    {entry.tags.map(tag => (
      <span class="tag" data-tag={tag}>{tag}</span>
    ))}
  </div>

  <div class="card-links">
    {entry.links.map(link => (
      <a href={link.url} target="_blank" rel="noopener noreferrer" class="link">
        {link.title}
        <span class="link-domain">({getDomain(link.url)})</span>
      </a>
    ))}
  </div>
</div>

<style>
  .entry-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.75rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    gap: 1.125rem;
    position: relative;
    animation: fadeIn 0.4s ease-out;
  }

  .edit-icon {
    position: absolute;
    top: 1rem;
    right: 1rem;
    color: #64748b;
    opacity: 0.6;
    transition: all 0.2s ease;
    text-decoration: none;
    font-size: 0.8125rem;
    font-weight: 500;
  }

  .edit-icon:hover {
    color: #0f172a;
    opacity: 1;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .entry-card:hover {
    border-color: #cbd5e1;
  }

  .entry-card.hidden {
    display: none;
  }

  .card-title {
    margin: 0;
    font-size: 1.375rem;
    font-weight: 600;
    line-height: 1.3;
    letter-spacing: -0.01em;
  }

  .card-title a {
    color: #0f172a;
    text-decoration: none;
    transition: color 0.2s ease;
    display: inline-block;
  }

  .card-title a:hover {
    color: #3b82f6;
  }

  .card-description-wrapper {
    flex: 1;
  }

  .card-description {
    margin: 0;
    color: #475569;
    line-height: 1.65;
    font-size: 0.9375rem;
  }

  .read-more-btn {
    margin-top: 0.5rem;
    background: none;
    border: none;
    color: #3b82f6;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    padding: 0;
    transition: color 0.2s ease;
    text-align: left;
  }

  .read-more-btn:hover {
    color: #2563eb;
    text-decoration: underline;
  }

  .card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag {
    background: #eff6ff;
    color: #1e40af;
    padding: 0.375rem 0.875rem;
    border-radius: 6px;
    font-size: 0.8125rem;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
    font-weight: 500;
    border: 1px solid transparent;
  }

  .tag:hover {
    background: #dbeafe;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(30, 64, 175, 0.15);
    border-color: #bfdbfe;
  }

  .tag.active {
    background: #3b82f6;
    color: white;
    border-color: #2563eb;
  }

  .card-links {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #f1f5f9;
    margin-top: 0.25rem;
  }

  .card-links .link {
    color: #3b82f6;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
  }

  .card-links .link:hover {
    color: #2563eb;
  }

  .card-links .link:hover .link-domain {
    color: #64748b;
  }

  .link-domain {
    color: #94a3af;
    font-weight: 400;
    font-size: 0.8125rem;
    transition: color 0.2s ease;
  }

</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const MAX_LENGTH = 150;
    const descriptionElements = document.querySelectorAll('.card-description[data-full-text]');

    descriptionElements.forEach(desc => {
      const fullText = desc.getAttribute('data-full-text') || '';
      const wrapper = desc.closest('.card-description-wrapper');
      const readMoreBtn = wrapper?.querySelector('.read-more-btn');

      if (!readMoreBtn || fullText.length <= MAX_LENGTH) {
        return;
      }

      let isExpanded = false;
      const truncatedText = fullText.slice(0, MAX_LENGTH) + '...';

      desc.textContent = truncatedText;
      desc.classList.add('truncated');
      readMoreBtn.style.display = 'block';
      readMoreBtn.textContent = 'Read more';

      readMoreBtn.addEventListener('click', () => {
        isExpanded = !isExpanded;
        if (isExpanded) {
          desc.textContent = fullText;
          desc.classList.remove('truncated');
          readMoreBtn.textContent = 'Show less';
        } else {
          desc.textContent = truncatedText;
          desc.classList.add('truncated');
          readMoreBtn.textContent = 'Read more';
        }
      });
    });
  });
</script>
